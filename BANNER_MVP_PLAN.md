# バナー作成MVP リファクタリング計画

## 1. 背景と目的
- 既存の「仕事用ツール」は複数ツールを1つのフレームワークで提供しているが、求められているのは**画像（バナー）生成機能のみ**。
- GitHub Pagesなど静的ホスティングに置いて、自分のAPIキーを入力すれば動作する**シンプルなバナー作成サイト**へ作り替える。
- 最低限残す要素は「左側のツール」「中央の指示パネル」「部分修正（マスク編集）機能」「API設定画面」。サイドバー、タブ、チャットUI、履歴等は廃止する。

## 2. ゴール
1. 画像生成と部分修正のコア体験を、単一ページと設定ページに集約して実装。
2. ユーザーが自身のAPIキーとエンドポイントを設定でき、ローカルストレージに保存される。
3. 既存Mixboardロジックから必要な部分のみ抽出し、保守しやすいモジュール構造に整理。
4. GitHub Pagesにホスト可能な静的構成（HTML/CSS/JSのみ）にする。

## 3. 画面構成
### 3.1 バナー作成ページ (`index.html`)
- **ヘッダー**：ブランドロゴ、API設定ページへのリンク、生成履歴のクリアボタン。
- **左ツールパネル**（縦列固定）  
  - プロンプト入力欄、スタイルプリセット（ブランド配色やフォントテンプレ）、キャンバスサイズ、生成枚数。  
  - アセット挿入（テキスト、ロゴ画像、背景カラー）、ダウンロードボタン。  
  - 「部分修正モードを開く」トグル。
- **中央指示＆キャンバス領域**  
  - 指示プレビュー（実際に送信するプロンプト合成結果 + パラメータ表示）。  
  - 生成結果ギャラリー（グリッド表示、選択でキャンバスに配置）。  
  - キャンバス上ではドラッグで位置調整、選択した要素にフローティングツールバー（再生成・複製・削除・ダウンロード）。
- **部分修正オーバーレイ**  
  - 既存Mixboardの`revisionOverlay`を簡素化して転用。  
  - 画像に描画したマスクと修正指示を送信→結果を元画像と置き換え。

### 3.2 API設定ページ (`settings.html`)
- 入力欄：APIベースURL、APIキー、モデル名、画像サイズ既定値、透過設定など。  
- プロバイダー選択（OpenAI / Anthropic / Custom）。選択に応じて想定エンドポイントとペイロードテンプレの説明を表示。  
- 保存時に `localStorage.bannerMvp.apiConfig` へ書き込み。バリデーションとテストAPI呼び出しボタンを提供。

## 4. 技術方針
1. **構成**：`index.html` + `settings.html` + `css/` + `js/` の静的サイト。既存`tools/`以下は削除し、必要なロジックのみ`js/banner.js`等に再構成。
2. **状態管理**：  
   - `localStorage` にAPI設定、最新生成パラメータ、キャンバス要素を保存。  
   - 将来的なState拡張を見据え、`bannerState`モジュールを定義。
3. **API通信**：  
   - `fetch`でユーザーが設定した`apiBaseUrl`へPOST。  
   - デフォルトはOpenAI Images API互換のJSONを送る。必要に応じて`provider`毎のpayload builder関数を用意。  
   - 失敗時はUIにエラーバナー表示、API設定画面へ誘導。
4. **キャンバス管理**：  
   - 既存Mixboardの`elements`配列と選択ロジックを縮小して転用。  
   - キャンバスの描画はDOMベース（HTML要素 + absolute positioning）を維持しつつ、コードを`CanvasController`クラスとして分離。
5. **部分修正**：  
   - `revisionOverlay` UIを簡略化して独立module化。  
   - マスクは`canvas`要素で描画し、生成指示と共にAPIへ送信（base64 PNG）。  
   - API設定に「部分修正エンドポイントURL」入力欄を用意し、未設定時はボタンを無効化。

## 5. 実装ステップ
1. **リポジトリ整理**  
   - 既存の`index.html`（iframeランチャー）、`tools/`配下、不要CSS/JSをアーカイブまたは削除。  
   - 新しい`index.html`/`settings.html`/`css/banner.css`/`js/banner.js`/`js/settings.js`/`js/state.js`を初期配置。
2. **UI構築**  
   - 新レイアウトのHTML骨組みとCSS（レスポンシブ・ライトテーマ）。  
   - 左ツールパネル + 中央キャンバス + モーダルの土台のみ先に置く。
3. **状態＆設定モジュール実装**  
   - API設定の保存/読み出し、バリデーション、ダミーテスト送信。  
   - バナー生成用の`buildPrompt()` `buildPayload()`等を定義。
4. **生成ワークフロー移植**  
   - Mixboardの生成処理（プレースホルダー表示、結果のDOM追加、エラーハンドリング）を抽出し、チャット無しでシンプル化。  
   - キャンバス要素（画像/テキスト）のCRUDとフローティングツールバーを実装。
5. **部分修正機能**  
   - 画像選択→オーバーレイ→マスク描画→API送信→結果反映のフローを再実装。  
   - 現行`revision`関連関数から必要部分のみ取り込み、UIとテキストを簡略化。
6. **API設定ページ連携**  
   - ヘッダーの「API設定」リンクから遷移/モーダル表示。  
   - 設定値が未入力の場合、生成ボタンと部分修正ボタンに警告表示。
7. **仕上げ**  
   - i18nテキストの整理（全UIを日本語で統一）。  
   - README更新、利用方法/API設定手順の追記。  
   - 動作確認（ローカルでダミーAPIを使ったfetchモックテスト）。

## 6. 非対象
- シナリオ作成・LP Builderなど他ツールのコード維持。
- 履歴管理、シェア、対話チャット、右部パネル等の高度UI。
- 認証やマルチユーザー対応。

## 7. リスクと対策
| リスク | 対策 |
| --- | --- |
| ブラウザから直接外部APIを叩けない（CORS/秘密情報） | API設定で「カスタムエンドポイントURL」を受け取り、必要ならユーザーが自前リレーサーバーを指定できるようにする。READMEで注意喚起。 |
| 既存ロジックの抜粋でバグを温存 | 移植箇所をモジュール単位で再実装し、不要コードを持ち込まない。 |
| 大きなbase64でlocalStorageが溢れる | 保存対象をメタデータのみに絞り、実画像は`URL.createObjectURL`または一時的な`File`参照で処理。 |

## 8. テスト観点
- API設定保存/読込、未設定時のアラート。
- 生成ボタン押下→プレースホルダー→成功/失敗挙動。
- キャンバス操作（配置、移動、複製、削除）。
- 部分修正モード（マスク描画、キャンセル、結果反映）。
- レスポンシブ表示（横幅768px以下で左パネル折りたたみ）。

## 9. 未決事項
1. 対応するAPIプロバイダーの初期セット（OpenAIのみか、既存サーバー互換か）。
2. GitHub Pagesでの実運用を想定したセキュリティ注意書きの記述場所（README or UI）。  
→ ユーザー確認後に仕様確定。

