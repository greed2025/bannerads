# LP Builder 改修仕様書

## 概要
LP Builderを以下の方針で改修する：
- 初回起動時のプロジェクト選択モーダル廃止
- タブ機能によるマルチプロジェクト管理
- サイドバーからのプロジェクト履歴管理連携
- スマホプレビュー専用化（スマホフレーム表示）

---

## 改修項目

### 1. 初回プロジェクト選択の廃止 & 起動時復元

| 項目 | 現状 | 改修後 |
|------|------|--------|
| 起動時 | プロジェクト選択モーダル表示 | 自動で前回タブ状態を復元 |
| モーダル | 表示される | 削除 |

**起動時復元フロー:**
```
起動
  ↓
LocalStorage「lpbuilder_tabs」を読込
  ↓
┌─ 存在する場合 ───────────────────────────────────┐
│ 各タブのprojectIdでIndexedDBからプロジェクト取得 │
│   ├→ 取得成功 → タブ復元                          │
│   └→ 取得失敗（削除/破損）→ そのタブはスキップ     │
│                                                  │
│ 復元後、有効タブが0件の場合 → 新規タブを自動作成   │
└──────────────────────────────────────────────────┘
  ↓
┌─ 存在しない場合 ─────────────────────────────────┐
│ 新規タブを1つ自動作成                             │
└──────────────────────────────────────────────────┘
```

**復元対象:** **開いていた全タブ**（アクティブタブ1件ではない）

**LocalStorage保存形式（タブ状態）:** `lpbuilder_tabs`
```javascript
{
    tabs: [
        { id: 'tab-uuid', projectId: 'project-uuid' }
    ],
    activeTabId: 'tab-uuid'
}
```

---

### 2. タブ機能の実装

```
┌─────────────────────────────────────────────────────────────┐
│  [×] LP1  │  [×] LP2  │  [×] LP3  │  [+]                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                      メインコンテンツ                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

| 項目 | 仕様 |
|------|------|
| タブ位置 | ヘッダー下部、コンテンツ上部 |
| 最大タブ数 | 5個 |
| 閉じるボタン | 各タブに [×] ボタン |
| 新規タブ | [+] ボタンで追加 |
| 未保存表示 | タブ名の横に ● 表示 |
| タブ切替保存 | 切替時に自動保存 |
| タブ名編集 | ダブルクリックで編集可能 |

**最大タブ数到達時:**
- [+] ボタンを非活性化（グレーアウト）
- ツールチップで「最大5タブまでです」と表示

**タブクローズ時:**
1. **未保存(isDirty=true)の場合**: 確認ダイアログ「未保存の変更があります。閉じますか？」
2. **最後のタブの場合**: 新規タブを自動作成（最低1タブ維持）

**データ構造:**
```javascript
state.tabs = [
    { id: 'uuid', name: 'LP1', projectId: 'project-uuid', isDirty: false },
    { id: 'uuid', name: 'LP2', projectId: 'project-uuid', isDirty: true }
];
state.activeTabId = 'uuid';
```

---

### 3. サイドバー連携

親ウィンドウ（index.html）のサイドバーからプロジェクト履歴を管理。

**postMessage安全性:**
| 対策 | 実装 |
|------|------|
| origin制限 | `event.origin === window.location.origin` のみ許可 |
| スキーマ検証 | `type`プロパティの存在・値チェック |
| 未知イベント | 無視（ログ出力のみ） |

**postMessageイベント:**

| イベント | 方向 | 内容 |
|----------|------|------|
| `switchProject` | 親→子 | プロジェクト切替 |
| `updateProjectList` | 子→親 | 履歴更新通知 |
| `deleteFromHistory` | 親→子 | 履歴から削除 |

**switchProject挙動:**
- 既に開いているプロジェクトの場合 → **既存タブにフォーカス**（新規タブは作らない）
- 開いていないプロジェクトの場合 → 新規タブで開く

**deleteFromHistory挙動:**
- 該当プロジェクトが開いている場合 → タブを閉じる（未保存確認あり）
- IndexedDBからも削除

**単独起動時（親ウィンドウなし）:**
- postMessage送信は行わない（`window.parent === window`で判定）
- LocalStorage・IndexedDBは通常通り使用
- サイドバー連携機能は無効（エラーにはしない）

**LocalStorageキー:** `lpbuilder_projects`（サイドバー用履歴）
```javascript
{
    projects: [
        { id, name, updatedAt }
    ],
    currentProjectId: 'uuid'
}
```

**LocalStorage ↔ IndexedDB同期:**
| 操作 | LocalStorage | IndexedDB |
|------|--------------|-----------|
| 保存時 | 履歴の`name`/`updatedAt`更新 | プロジェクト全体保存 |
| 削除時 | 履歴から削除 | データ削除 |
| 起動時 | 履歴読込 | 各projectIdで実データ取得 |
| 不整合検知 | 該当項目を履歴から削除 | - |

---

### 4. スマホプレビュー専用化

| 項目 | 現状 | 改修後 |
|------|------|--------|
| ビューポート切替 | PC/タブレット/スマホ | **スマホのみ** |
| プレビュー表示 | 単純なiframe | **スマホフレーム付き** |
| サイズ | 可変 | **375 × 812px (iPhone X相当)** |

**スマホフレームデザイン:**
```
     ┌──────────────────────────────────────┐
     │         ─────────────────           │ ← スピーカー
     │  ┌────────────────────────────────┐ │
     │  │                                │ │
     │  │                                │ │
     │  │        プレビューiframe          │ │
     │  │                                │ │
     │  │                                │ │
     │  │                                │ │
     │  └────────────────────────────────┘ │
     │            ──────────              │ ← ホームインジケータ
     └──────────────────────────────────────┘
```

**CSS実装:**
- 角丸のスマホ筐体（border-radius: 40px）
- 上部にノッチ（黒背景の半円）
- 下部にホームインジケータ（白いバー）
- スクロール可能なプレビュー
- グレーの背景でスマホが浮き上がる表現

---

## ファイル変更一覧

| ファイル | 変更内容 |
|----------|----------|
| `lpbuilder.html` | タブUI追加、ビューポートボタン削除、スマホフレーム追加、モーダル削除 |
| `lpbuilder.css` | タブスタイル、スマホフレームスタイル追加 |
| `lpbuilder.js` | タブ管理、サイドバー連携、自動起動処理、postMessageハンドラ |
| `../../../js/app.js` | lpbuilder用の履歴読込追加 |

---

## 削除項目

- [x] プロジェクト選択モーダル（.js-project-modal）
- [x] ビューポート切替ボタン（.viewport-controls）
- [x] タブレット/PCビューポート関連CSS
- [x] ヘッダーのプロジェクト名入力欄（タブ名編集に統一）

---

## UI変更前後比較

### 改修前
```
┌─ヘッダー───────────────────────────────────────┐
│ [←] プロジェクト名  [PC][Tab][SP]  [Export][Save]│
├────────────────────────────────────────────────┤
│ [Preview][HTML][CSS][JS]                 タブ切替│
├────────────────────────────────────────────────┤
│                                        │チャット│
│           プレビュー/エディタ             │パネル │
│                                        │       │
└────────────────────────────────────────────────┘
```

### 改修後
```
┌─ヘッダー──────────────────────────────────────────┐
│ [←]  [画像生成][テンプレ][ZIP出力][保存]           │
├──────────────────────────────────────────────────┤
│ [×]LP1● │ [×]LP2 │ [+]           プロジェクトタブ│
├──────────────────────────────────────────────────┤
│ [Preview][HTML][CSS][JS]                  タブ切替│
├──────────────────────────────────────────────────┤
│      ┌─────────────┐              │チャットパネル │
│      │  📱 スマホ   │              │              │
│      │  フレーム    │              │              │
│      │             │              │              │
│      └─────────────┘              │              │
└──────────────────────────────────────────────────┘
```

---

## テスト観点

### タブ機能
- [ ] 新規タブ追加（5タブまで）
- [ ] 5タブ時の[+]ボタン非活性
- [ ] タブ切替時の自動保存
- [ ] 未保存タブ(●表示)の閉じる確認ダイアログ
- [ ] 最後のタブを閉じた時の新規タブ自動作成
- [ ] タブ名ダブルクリック編集

### 起動時復元
- [ ] 正常復元（複数タブ）
- [ ] currentProjectId不在時 → 新規タブ作成
- [ ] 一部プロジェクト削除済み → 該当タブスキップ
- [ ] 全プロジェクト削除済み → 新規タブ作成

### postMessage連携
- [ ] origin不一致のメッセージ拒否
- [ ] 未知のtypeのメッセージ無視
- [ ] switchProject: 既存タブにフォーカス
- [ ] switchProject: 新規タブで開く
- [ ] deleteFromHistory: 開いているタブの閉じる確認
- [ ] 単独起動時に連携が無効でもエラーにならない

### スマホプレビュー
- [ ] 375×812pxで表示
- [ ] スマホフレームのデザイン確認
- [ ] プレビュー内スクロール動作

---

## 実装順序

1. タブUI追加（HTML/CSS）
2. タブ管理ロジック実装（JS）
3. プロジェクト選択モーダル削除
4. ビューポート切替削除 → スマホ専用化
5. スマホフレームUI実装
6. サイドバー連携（postMessage）
7. テスト・調整
