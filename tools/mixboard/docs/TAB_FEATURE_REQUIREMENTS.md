# Mixboard タブ機能 要件定義書

**作成日**: 2025-12-19  
**更新日**: 2025-12-19  
**作成者**: [名前]  
**レビュー者**: [先輩名]  
**ステータス**: レビュー指摘対応済み

---

## 1. 概要

### 1.1 背景
現在のMixboardは単一キャンバスで動作しており、複数の作業を並行して行う際に不便が生じている。

### 1.2 目的
ブラウザのタブのように、複数のプロジェクトを同時に開いて切り替えられる機能を実装し、ユーザーの作業効率を向上させる。

### 1.3 対象ユーザー
Mixboardを使用する全ユーザー

### 1.4 前提条件
- **既存データ形式**: IndexedDB（`mixboard_db`）に単一プロジェクトのelementsを保存
- **旧フォーマット**: localStorage（`mixboard_projects_v3`など）からの移行も対応

---

## 2. 機能要件

### 2.1 タブ操作

| No | 機能 | 詳細 | 優先度 |
|----|------|------|--------|
| F-01 | タブ追加 | 「+」ボタンで新規プロジェクト作成、作成後は自動でアクティブ化 | 必須 |
| F-02 | タブ切り替え | タブクリックでプロジェクト切り替え、切り替え前に現在のプロジェクトを即時保存 | 必須 |
| F-03 | タブ名変更 | ダブルクリックでインライン編集 | 必須 |
| F-04 | タブ削除 | ×ボタンで削除確認ダイアログ表示後に削除 | 必須 |
| F-05 | タブ並び替え | ドラッグ&ドロップで順序変更 | 任意（v2） |

### 2.2 タブ削除の詳細ルール

| 条件 | 動作 |
|------|------|
| 最後の1つを削除 | 削除不可、トースト通知 |
| アクティブタブを削除 | 左隣のタブに遷移（なければ右隣） |
| 削除確認 | 「このプロジェクトを削除しますか？」ダイアログ |
| 復元機能 | v1では未実装（将来的にゴミ箱機能を検討） |

### 2.3 タブ名の制約

| 項目 | 制約 |
|------|------|
| 空文字 | 不可（元の名前を維持） |
| 前後スペース | 自動トリム |
| 最大文字数 | 30文字（超過時は切り捨て） |
| 重複名 | 許可（IDで一意性を担保） |

### 2.4 タブ上限とオーバーフロー

| 項目 | 仕様 |
|------|------|
| タブ上限 | 10個（パフォーマンス確保のため） |
| 上限超過時 | 新規作成不可、トースト通知 |
| オーバーフローUI | 横スクロール（矢印ボタン表示） |

---

## 3. データ管理

### 3.1 保存タイミング

| No | タイミング | 方式 | 備考 |
|----|------------|------|------|
| S-01 | 操作後5秒（デバウンス） | 自動保存 | 連続操作時の負荷軽減 |
| S-02 | タブ切り替え時 | 即時保存 | |
| S-03 | ページ離脱時 | ベストエフォート | beforeunload/pagehide/visibilitychange |
| S-04 | タブ削除時 | 即時保存 | |

> **S-03について**: ページ離脱時の保存は完了保証がないため「ベストエフォート」とする。
> - `beforeunload`イベントで保存を試行
> - `visibilitychange`（hidden時）でも補助的に保存
> - 失敗時の通知は不可（ページ離脱後のため）
> - 重要な作業は手動保存を推奨（ドキュメントに記載）

### 3.2 Undo/Redo履歴

| 項目 | 仕様 |
|------|------|
| 管理単位 | プロジェクト単位 |
| 保持件数 | 最大50件（超過時は古いものから削除） |
| リロード後 | **履歴は破棄**（要素の状態のみ復元） |
| 保存対象 | 履歴はメモリ上のみ、IndexedDBには保存しない |

> **設計意図**: 履歴をIndexedDBに保存すると容量肥大化・パフォーマンス劣化のリスクがあるため、リロード後は履歴なしでスタート

### 3.3 保存失敗時の対応

| 状態 | 対応 |
|------|------|
| 初回失敗 | トースト通知 + 30秒後に自動リトライ |
| リトライ失敗 | エラー状態アイコン表示 + 手動保存ボタン有効化 |
| 手動保存 | ヘッダーに「保存」ボタン追加（エラー時のみ表示） |

---

## 4. データ移行

### 4.1 旧フォーマット対応

| キー | 形式 | 対応 |
|------|------|------|
| `mixboard_db` (IndexedDB) | 単一elements配列 | 新形式に自動移行 |
| `mixboard_projects_v3` (localStorage) | 旧プロジェクト形式 | 新形式に自動移行 |

### 4.2 移行処理フロー

```
1. 新形式データ存在確認
   ├─ 存在する → 新形式で読み込み
   └─ 存在しない → 旧データ移行処理へ

2. 旧データ移行処理
   ├─ IndexedDB旧形式確認 → 移行
   └─ localStorage確認 → 移行

3. 移行成功時
   ├─ 新形式で保存
   └─ 旧データを「backup_」プレフィックス付きで退避（削除しない）

4. 移行失敗時
   ├─ エラーログ出力
   ├─ トースト通知「データ移行に失敗しました」
   └─ 空のプロジェクトで開始（旧データは保持）
```

### 4.3 10件超の旧データ移行

| 条件 | 対応 |
|------|------|
| 旧データが10件以下 | 全件移行 |
| 旧データが10件超 | 更新日時の新しい順に10件を移行 |
| 移行されなかったデータ | `backup_`プレフィックス付きで退避 |
| 通知 | 「一部のプロジェクトは移行されませんでした」トースト |

### 4.4 ロールバック

- 移行失敗時は旧データを**削除しない**
- 旧データは`backup_`プレフィックス付きで保持
- 将来的な手動復元に対応

---

## 5. 競合解決（複数ブラウザタブ対応）

### 5.1 方針
**最後に保存した内容が優先**（Last Write Wins）

### 5.2 詳細

| 項目 | 対応 |
|------|------|
| 同時編集検知 | 未対応（v1スコープ外） |
| 警告 | なし（シンプルな上書き方式） |
| 将来対応 | BroadcastChannel APIによる同期を検討 |

> **v1での割り切り**: 複数ブラウザタブでの同時編集はサポート対象外。最後に保存した内容が残る。

---

## 6. 非機能要件

### 6.1 パフォーマンス

| No | 要件 | 目標値 | 測定条件 |
|----|------|--------|----------|
| P-01 | タブ切り替え | 100ms以内 | 10タブ・各100要素・M1 Mac |
| P-02 | 保存処理時間 | 500ms以内 | IndexedDB書き込み完了まで |
| P-03 | 初期読み込み | 2秒以内 | 10タブ・各100要素・M1 Mac |

> **P-02について**: デバウンス待機時間（5秒）とは別に、実際の保存処理そのものの実行時間を500ms以内とする。

### 6.2 データ保存

| No | 要件 | 詳細 |
|----|------|------|
| S-01 | 保存方式 | IndexedDB（容量制限回避のため） |
| S-02 | DBバージョン | 4（既存v3との互換性のため） |
| S-03 | 保存タイミング | デバウンス + 即時保存（上記参照） |

---

## 7. UI設計

### 7.1 タブバー配置

```
┌──────────────────────────────────────────────────┐
│ [◀] [Project 1] [Project 2] [Project 3] [+] [▶] │ ← タブバー（スクロール対応）
├──────────────────────────────────────────────────┤
│                                                  │
│                 キャンバス領域                     │
│                                                  │
└──────────────────────────────────────────────────┘
```

### 7.2 タブUI要素

| 要素 | 説明 |
|------|------|
| タブ名 | クリックで切り替え、ダブルクリックで編集、最大30文字 |
| ×ボタン | ホバー時に表示、クリックで削除確認 |
| +ボタン | タブ追加（10個上限時は非活性） |
| ◀▶ボタン | タブが溢れた場合にスクロール |
| エラーアイコン | 保存失敗時に表示 |
| 手動保存ボタン | 保存失敗時のみ表示、クリックで即時保存を試行 |

---

## 8. データ構造

```javascript
// プロジェクトデータ（IndexedDB保存）
{
  id: 'proj_xxxxx',      // ユニークID
  name: 'Project 1',     // 表示名（最大30文字）
  elements: [],          // キャンバス上の要素
  createdAt: 'ISO日時',
  updatedAt: 'ISO日時'
}
// 注意: history/historyIndexはメモリ上のみで保持、IndexedDBには保存しない

// 保存データ（IndexedDB）
{
  id: 'mixboard_projects_v4',
  projects: [...],       // プロジェクト配列（最大10件）
  currentProjectId: 'proj_xxxxx',
  updatedAt: 'ISO日時'
}
```

---

## 9. 影響範囲

### 9.1 変更ファイル

| ファイル | 変更内容 |
|----------|----------|
| mixboard.html | タブバーHTML追加 |
| mixboard.css | タブ関連スタイル追加 |
| mixboard.js | タブ管理ロジック追加、保存ロジック修正 |

### 9.2 既存機能への影響

| 機能 | 影響 |
|------|------|
| Undo/Redo | プロジェクト単位での履歴管理に変更（メモリのみ） |
| 自動保存 | デバウンス＋即時保存の組み合わせに変更 |
| 初期化処理 | タブ読み込み・移行処理を追加 |

---

## 10. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| データ移行失敗 | 高 | 旧データを削除せず退避、ロールバック可能 |
| IndexedDB容量超過 | 中 | 履歴をIndexedDBに保存しない、タブ上限10個 |
| 複数タブ競合 | 中 | v1ではLast Write Wins、v2でBroadcastChannel検討 |
| 大量要素でのパフォーマンス低下 | 中 | パフォーマンス測定条件を明確化 |

---

## 11. テスト項目

### 11.1 正常系
- [ ] タブ追加・削除・切り替えが正常に動作する
- [ ] タブ名の編集・保存が正常に動作する
- [ ] ページリロード後にデータが復元される
- [ ] Undo/Redoがプロジェクト単位で動作する
- [ ] 最後のタブは削除できない

### 11.2 異常系・境界値
- [ ] 10個目のタブ作成後、+ボタンが非活性になる
- [ ] アクティブタブ削除時に左隣に遷移する
- [ ] タブ名30文字超過時に切り捨てられる
- [ ] 保存失敗時にエラーアイコンと手動保存ボタンが表示される
- [ ] 手動保存ボタンクリックで保存が実行される
- [ ] 旧データ移行が正常に動作する
- [ ] 移行失敗時に旧データが保持される
- [ ] 旧データが10件超の場合、更新日時の新しい順に10件が移行される
- [ ] ページリロード後にUndo/Redo履歴が破棄されている

### 11.3 スコープ外（v1）
- [ ] 複数ブラウザタブ同時編集の競合解決
- [ ] タブのドラッグ並び替え
- [ ] ゴミ箱・復元機能

---

## 12. スケジュール（案）

| フェーズ | 内容 | 工数（目安） |
|----------|------|-------------|
| 設計 | 詳細設計・UI確定 | 0.5日 |
| 実装 | HTML/CSS/JS実装 | 2日 |
| テスト | 単体・結合テスト | 1日 |
| レビュー | コードレビュー・修正 | 0.5日 |

---

## 13. v2で検討する機能

1. タブの並び替え（ドラッグ&ドロップ）
2. ゴミ箱・復元機能
3. BroadcastChannel APIによる複数タブ同期
4. プロジェクトのエクスポート/インポート
5. Undo/Redo履歴の永続化オプション

---

**レビューコメント欄**

```
（レビュー者記入欄）


```
